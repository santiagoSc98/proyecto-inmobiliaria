<%- include ("elements/header") %>

  <% if (sessionLog) { %>

    <link rel="stylesheet" href="./assets/css/sty.css" />
    </div>
    <!-- partial:index.partial.html -->
    <div class="app-container">
      <div class="sidebar">
        <ul class="sidebar-list">
          <div class="account-info">
            <div class="account-info-picture">
              <img
                src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS_-r1taW-jqqIsiDGkpEsQTGv3E-aETHZYR9ORvyZV9bfQaAMywPPW9konKpFvgFja5bs&usqp=CAU"
                alt="Account">
            </div>
            <span class="account-info-name">
              <%= sessionLog.nombre %>
            </span>
          </div>
          <li class="sidebar-list-item">
            <a href="/home">
              <span class="iconify"  data-width="18" data-icon="ant-design:home-outlined"></span>
              <span>Inicio</span>
            </a>
          </li>

          <li id="barraperfil" class="sidebar-list-item">
            <a onclick="getperfil()" style="cursor: pointer;">
              <span class="iconify" data-icon="ep:user" data-width="18"></span>
              <span>Perfil</span>
            </a>
          </li>

          <li id="barrapublicacion" class="sidebar-list-item active">
            <a href="#">
              <span class="iconify"  data-width="18" data-icon="akar-icons:shipping-box-01"></span>
              <span>Publicaciones</span>
            </a>
          </li>
          <li class="sidebar-list-item">
            <a href="#">
              <span class="iconify"  data-width="18" data-icon="wpf:statistics"></span>
              <span>Estadisticas</span>
            </a>
          </li>
          <li class="sidebar-list-item">
            <a href="#">
              <span class="iconify"  data-width="18" data-icon="ant-design:message-outlined"></span>
              <span>Inbox</span>
            </a>
          </li>
          <li class="sidebar-list-item">
            <a href="#">
              <span class="iconify"  data-width="18" data-icon="akar-icons:bell"></span>
              <span>Notifications</span>
            </a>
          </li>
        </ul>
        <div class="account-info">
          <div class="account-info-name sidebar ">
            <a id="cerrarr" href="javascript:void(0)" style="display:flex ;align-items: center;">
             <span style="margin-right:10px">Cerrar Sesion</span> 
              <span class="iconify"  data-width="18" data-icon="uiw:logout" data-width="15" data-height="15"></span></a></div>
        </div>
      </div>
      <div class="app-content">
        <div id="propiedades">
          <div class="app-content-header">
            <h1 class="app-content-headerText">Publicaciones</h1>
            <a href="add" class="app-content-headerButton">Publicar</a>
          </div>
          <div class="app-content-actions">
            <input class="search-bar" placeholder="Buscar..." type="text">
            <div class="app-content-actions-wrapper">
              <div class="filter-button-wrapper">
                <button class="action-button filter jsFilter"><span>Filtrar</span>
                  <span class="iconify" data-icon="charm:filter" ></span>
                </button>
                <div class="filter-menu">
                  <label>Categorias</label>
                  <select>
                    <option>Todas las Categorias</option>
                  </select>
                  <label>Estado</label>
                  <select>
                    <option>Todos los Estados</option>
                    <option>Disponible</option>
                    <option>No Dispponible</option>
                  </select>
                  <div class="filter-menu-buttons">
                    <button class="filter-button reset">
                      Resetear
                    </button>
                    <button class="filter-button apply">
                      Aplicar
                    </button>
                  </div>
                </div>
              </div>
              <button class="action-button list active" title="List View">
                <span class="iconify" data-icon="ant-design:unordered-list-outlined" ></span>
              </button>
              <button id="grid" class="action-button" title="Grid View">
                <span class="iconify" data-icon="bi:grid-fill" ></span>

              </button>
            </div>
          </div>
          <div class="products-area-wrapper tableView">
            <div class="products-header">
              <div class="product-cell image">
                Publicacion
                <button class="sort-button">
                </button>
              </div>

              <div class="product-cell category">Tipo de Propiedad<button class="sort-button">
                </button>
              </div>
              <div class="product-cell sales">Tipo de Publicacion<button class="sort-button">
                </button>
              </div>
            
              <div class="product-cell stock">Dirección<button class="sort-button">
                </button>
              </div>
              <div class="product-cell price">Superfice<button class="sort-button">
                </button>
              </div>
              <div class="product-cell price">Precio<button class="sort-button">
                </button>
              </div>
              <div class="product-cell status-cell">Estado<button class="sort-button">
              </button>
            </div>
            <div class="product-cell accion">Accion<button class="sort-button">
            </button>
          </div>
            </div>
            <% for(var i=0; i<propiedades.length; i++){ %>

              <div class="products-row">
                <button class="cell-more-button">
                  <span class="iconify" data-icon="akar-icons:more-vertical" ></span>
                </button>
                <div class="product-cell image">
                  <% if (propiedades[i].img==null || propiedades[i].img=="" ){ %>
                    <img
                      src="https://thumbs.dreamstime.com/b/casa-de-vuelo-en-la-ilustraci%C3%B3n-del-vector-esbozo-nubes-las-dibujo-grabado-vectorial-dise%C3%B1o-impresi%C3%B3n-ropa-camisa-imitaci%C3%B3n-195250717.jpg"
                      alt="product">
                    <% } else { %>
                      <!-- <img src="<%= propiedades[i].img  %>" alt="product"> -->
                      <video playsinline="" autoplay="" loop="" muted="" poster="<%= propiedades[i].img  %>" alt="Responsive image">
                        <source src="<%= propiedades[i].img  %>"  type="video/mp4">
                      </video>
                      <% } %>
                        <span>
                          <%= propiedades[i].nombre %>
                        </span>
                </div>
                <div class="product-cell category">
                  <span class="cell-label">Tipo de Propiedad:</span>
                  <%= propiedades[i].dcp %>
                </div>
                <div class="product-cell sales">
                  <span class="cell-label">Tipo de Publicacion:</span>
                  <%= propiedades[i].tipo_publicacion %>
                </div>
                <div class="product-cell stock"><span class="cell-label">Dirección:</span>
                  <%= propiedades[i].direccion %> - <%= propiedades[i].ciudad %>
                </div>
                <div class="product-cell Superfice"><span class="cell-label">Superficie:</span>
                  <%= propiedades[i].superficieM2 %>
                </div>
                <div class="product-cell price"><span class="cell-label">Precio:</span>
                  <%= propiedades[i].precio %> Gs
                </div>
                <div class="product-cell status-cell">
                  <span class="cell-label">Estado:</span>
                  <% if (propiedades[i].estado==1) { %>
                    <a href="javascript:void(0)" onclick="changestatus(this)" data-estado="1"
                      data-propiedadid="<%= propiedades[i].id_propiedad %>" class="status active">Disponible</a>
                    <% } else{ %>
                      <a href="javascript:void(0)" onclick="changestatus(this)" data-estado="0"
                        data-propiedadid="<%= propiedades[i].id_propiedad %> " class="status disabled">No Disponible</a>
                      <% } %>
                </div>
                <div class="product-cell accion"><span class="cell-label">Accion:</span>
                  <div style="display: flex;width: 70%;justify-content: space-between;">
                    <div>
                      <a href="javascript:value(0)" onclick="openedit(this)" data-propiedadid="<%= propiedades[i].id_propiedad %> " >
                      <span class="iconify"  data-icon="akar-icons:edit" data-width="30" data-height="30" style="color: #57b889;"></span>
                      </a>
                    </div>
                    <div>
                      <a href="javascript:value(0)" data-propiedadid="<%= propiedades[i].id_propiedad %> "  onclick="alert(this)">
                      <span class="iconify"  data-icon="ep:delete" data-width="30" data-height="30" style="color: #d95050;"></span>
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              <% }  %>
          </div>
        </div>
        <div id="perfil2" style="display: none">
          <div class="app-content-header" >
            <h1 class="app-content-headerText">Perfil</h1>
          </div>
          <div style="text-align: -webkit-center;">
            <form action="/editarperfil" method="post" enctype="multipart/form-data">
              <input  type="hidden" name="token" id="token"  value="javascript:localStorage.getItem('token')">
              <div>
         
              </div>
              <div class="card-prof">
                <% if(sessionLog.id_tipousuario == 2) {%>

                  <% if(sessionLog.foto != "none" || sessionLog.foto != "" || sessionLog.foto != null ) {%>
                      <img src="<%= sessionLog.foto %>">
                    <% } %>
                  

                  <h3>Foto de Perfil</h3>
                    <input  data-image-uploader multiple  type="file"  accept="image/*" capture="camera" name="file" id="upload" style="z-index:99 ;">
                    <div data-image-uploads class="images-holder"></div>
                
              <% } %>
                <h3>Nombre Completo</h3>
                <input disabled value="nombre" name="nombre" id="nombre">

                <h3>Telefono</h3>
                <input disabled value="" type="number" name="telefono" id="telefono">

                <h3>Direccion</h3>
                <input disabled value="direccion" placeholder="Ingrese su direccion" name="direccion" id="direccion">

                <h3>Email</h3>
                <input  disabled value="email" name="email" id="email">
                
                <h3>Documento Identificador</h3>
                <input disabled placeholder="Ingrese su Documento Identificador" name="documentoidentificador" value="documentoidentificador" id="documentoidentificador">
                <div class="fbtn">
                  <button type="submit" style="display:none ;" class="app-content-headerButton sav">Guardar</button>
                  <a href="#" class="app-content-headerButton enable" >Editar</a>
                </div>
              
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <script src="assets/js/uploadfile.js"></script>


    <style>
      .fbtn{
        display: flex;
        justify-content: flex-end;
        margin-top: 20px;
      }
      input{
        width: 100%;
        border: 1px solid #00000021;
        padding: 6px;
        border-radius: 5px;
      }
      .card-prof {
          border-radius: 5px;
          max-width: 60%;
          padding: 20px;
          text-align: initial;
          margin-top: 5%;
          box-shadow: 0px 0px 2px;
      }
      @media screen and (max-width: 1024px){
        .card-prof {
          max-width: 100%;
        }
      }
      .tableView .product-cell video {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        margin-right: 6px;
        object-fit: cover;
      }
      .gridView .product-cell video {
        width: 100%;
        height: 150px;
        -o-object-fit: cover;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 16px;
    }
    .app-content{
      overflow-y: auto;
      overflow-x: hidden;
    }
    </style>
    <script type="text/javascript">
      $(document).ready(function () {
		  	$("#token").val(localStorage.getItem("token"))
		  })
      document.querySelector(".jsFilter").addEventListener("click", function () {
        document.querySelector(".filter-menu").classList.toggle("active");
      });

      document.querySelector("#grid").addEventListener("click", function () {
        document.querySelector(".list").classList.remove("active");
        document.querySelector("#grid").classList.add("active");
        document.querySelector(".products-area-wrapper").classList.add("gridView");
        document
          .querySelector(".products-area-wrapper")
          .classList.remove("tableView");
      });

      document.querySelector(".list").addEventListener("click", function () {
        document.querySelector(".list").classList.add("active");
        document.querySelector("#grid").classList.remove("active");
        document.querySelector(".products-area-wrapper").classList.remove("gridView");
        document.querySelector(".products-area-wrapper").classList.add("tableView");
      });

      if ($(window).width() < 767) {
        $("#grid").click()
      }
      
      $("#cerrarr,#close-mb").click(function () {

        $.ajax({
          type: "POST",
          url: "logout",
          data: { "token": localStorage.getItem("token") },
          success: function (data2) {
            localStorage.clear();
            console.log("cerraste sesion");
            window.location.href = "/home"
          }
        })
      })

      function changestatus(e) {
        var id_propiedad = e.getAttribute("data-propiedadid");
        var estado = e.getAttribute("data-estado");
        var newestado = 0
        var estadostr = ""
        var stado = ""

        if (estado == 1) {

          newestado = 0
          estadostr = "No Disponible"
          stado = " disabled"

        } else {
          newestado = 1
          estadostr = "Disponible"
          stado = " active"
        }
        $.ajax({
          url: "changepropiedadestatus",
          method: "POST",
          data: {
            estado: newestado,
            id_propiedad: id_propiedad,
            token: localStorage.getItem("token")

          },
          success: function (data3) {
            if (data3.status == 0) {
              console.log("todomal", data3.mensaje)
            } else {
              console.log("Funciona")
              e.innerHTML = estadostr
              e.setAttribute("class", "status" + stado);
              e.setAttribute("data-estado", newestado)

            }
          }
        })
      }
      
      function alert(elElemento){

        Swal.fire({
        title: '¿Está seguro?',
        text: "¡No podrás revertir esto!",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'si, eliminarlo!',
        cancelButtonText:'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          var id_propiedad = elElemento.getAttribute("data-propiedadid");
          $.ajax({
            url: "changepropiedadestatus",
            method: "POST",
            data: {
              estado: 2,
              id_propiedad: id_propiedad,
              token: localStorage.getItem("token")
            },
            success: function (data){
              console.log("funca")
              Swal.fire(
                'Eliminado!',
                'Su propiedad ha sido elimiado con exito.',
                'success'
              ).then((result) => {
              window.location.href = "/dashboard"
              })
            }
          })
        }
      })
      }
     
      function openedit(e){

        var id_propiedad = e.getAttribute("data-propiedadid")

        var form = document.createElement("form")
        var element1 = document.createElement("input")
        var element2 = document.createElement("input")

        form.method = "POST"
        form.action = "edit"

        element1.value=localStorage.getItem("token")

        element1.name= "token"
        element1.type = "hidden"
        form.appendChild(element1)

        element2.value= id_propiedad

        element2.name= "id_propiedad"
        element2.type = "hidden"
        form.appendChild(element2)

        document.body.appendChild(form)

        form.submit()

      }
       
      function getperfil(){
        lafunction("get")
      }

      function lafunction(quienmellama){

        var dsturl = ""

        // let dato 

        if (quienmellama == "get") {
          
          dsturk = "getperfil"
          dato = {
              token: localStorage.getItem("token")
            }

        } else {
          
          //  dato =  new FormData(document.getElementById('formfoto'))
          var dato = new FormData($('#formfoto')[0])

          
            // jQuery.each($('#upload')[0].files,function(i,file){
            
            //     dato.append("file[]", file)
            //    console.log("dattopoppppp",dato)
            //  })
             console.log("jejeseavvbo",dato)
        
          dsturk = "editarperfil"
       
          dato.token = localStorage.getItem("token")
          dato.nombre = $("#nombre").val() ,
          dato.telefono =$("#telefono").val() ,
          dato.direccion = $("#direccion").val(),
          dato.email = $("#email").val(),
          dato.documentoidentificador = $("#documentoidentificador").val()

          console.log ("todo guardado",dato)
          
        }

        $.ajax({
            url: dsturk,
            method: "POST",
            // contentType:"multipart/form-data",
            data: dato ,
            success: function (data){

              if (quienmellama == "get") {

                var datodelusuario = data.data
          
                if (datodelusuario.telefono == 0) {
                  $('#telefono').attr("placeholder","Ingrese su telefono")
                } else{
                  $('#telefono').val(datodelusuario.telefono)
                }

                $('#nombre').val(datodelusuario.nombre)
              
                $('#direccion').val(datodelusuario.direccion)
                $('#email').val(datodelusuario.email)
                $('#documentoidentificador').val(datodelusuario.documentoidentificador)
                // $('#pass').val(datodelusuario.pass)
            
                $( "#perfil2").show();
                $('#propiedades').hide();
                $('#barrapublicacion').removeClass('active')
                $( "#barraperfil").addClass('active');

              } else {

                console.log("Actualizado perfil en el frente")

              }
            }
          })
      }
     
      $('#barrapublicacion').click(function(){
        $( "#perfil2").hide();
        $('#propiedades').show();
        $('#barrapublicacion').addClass('active')
        $( "#barraperfil").removeClass('active');
      })

      $('.enable').click(function(){
        $('input').prop('disabled', false);
        $('.sav').show();
        $('.enable').hide();
        
      })
    </script>
    </body>
    <% } else { %>

  <script>
    if(localStorage.getItem("token")){
      opendashboard()
    } else {
      window.location.href = "/home"
    }
    
  </script>


    <% } %>